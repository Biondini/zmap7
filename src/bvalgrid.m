function bvalgrid() % autogenerated function wrapper
    % This subroutine assigns creates a grid with
    % spacing dx,dy (in degreees). The size will
    % be selected interactively. The bvalue in each
    % volume around a grid point containing ni earthquakes
    % will be calculated as well as the magnitude
    % of completness
    %   Stefan Wiemer 1/95
    % turned into function by Celso G Reyes 2017
    
    ZG=ZmapGlobal.Data; % used by get_zmap_globals
    
    %TODO: have this check for an already selected polygon, and use these points
    
    report_this_filefun(mfilename('fullpath'));
    
    % get the grid parameter
    % initial values
    %
    dx = 1.00;
    dy = 1.00 ;
    ni = 100;
    ra = ZG.ra;
    Nmin = 50;
    fMcFix=2.2;
    nBstSample=100;
    fMccorr = 0.2;
    fBinning = 0.1;
    stan2 = NaN;
    stan = NaN;
    prf = NaN;
    av = NaN;
    fStdDevB = NaN;
    fStdDevMc = NaN;
    bGridEntireArea = false;
    bCreateGrid = true;
    bLoadGrid = ~bCreateGrid;
    bUseNiEvents= true;
    lab1=' ';
    
    % make the interface
    %
    figure_w_normalized_uicontrolunits(...
        'Name','Grid Input Parameter',...
        'NumberTitle','off',...
        'NextPlot','new', ...
        ...'Visible','off', ...
        'MenuBar','none',...
        'Position',[ ZG.wex+200 ZG.wey-200 700 275]);
    axis off
    
    % Get list of Mc computation possibilities
    [labelList2] = calc_Mc();
    
    uicontrol('Style','text',...
        'Position',[0.02 0.85 .4 0.1 ],...
        'FontSize',ZmapGlobal.Data.fontsz.m ,...
        'HorizontalAlignment','right',...
        'String','Magnitude of Completeness (Mc) method:');
    
    hMcChoice=uicontrol(...
        'Style','popup',...
        'Position',[0.44 0.85  0.53  0.1],...
        'FontSize',ZmapGlobal.Data.fontsz.m ,...
        'String',labelList2,...
        'callback',@callbackfun_001);
    
    % Set selection to 'Best combination'
    hMcChoice.Value=1;
    
    
    % Edit fields, radiobuttons, and checkbox
    
    % oldfig_button = uicontrol('BackGroundColor',[.60 .92 .84], 'Style','checkbox','String','Plot in Current Figure','Position',[.65 .20 .20 .08]);
    % set(oldfig_button,'value',1);
    
    % button group
    ubg1=uibuttongroup('Title','Event Selection','Position',[0.03 .52 .45 .28]); % control for tgl1 and tlg2
    hUseNevents = uicontrol(ubg1,'Style','radiobutton','Position',[.05 .60 .9 0.35],...
        'String','Number of Nearest Events');
    
    hUseRadius =  uicontrol(ubg1,'Style','radiobutton','Position',[.05 .10 .9 0.35],...
        'String','Events within Constant Radius (km)');
    
    hNi=uicontrol(ubg1,'Style','edit','Position',[.75 .6 0.23 .35],'String',num2str(ni),'callback',@callbackfun_ni, 'ToolTipString','# closest events to include');
    hRa=uicontrol(ubg1,'Style','edit','Position',[.75 .1 0.23 .35],'String',num2str(ra),'callback',@callbackfun_ra, 'ToolTipString','event selection radius');
    
    ubg1.SelectedObject=hUseNevents; %constant number of events
    hRa.Enable='off';
    ubg1.SelectionChangedFcn=@callback_selectioncontrol;
    
    
    
    % Grid options
    gridOpts = GridParameterChoice(gcf,[351, 83], dx, dy);
    
    %{
     %   % replaced by GridParameterChoice object
    
    % Create, Load, or use Previous grid choice
    ubg2=uibuttongroup('Title','Grid options', 'Position',[0.5 .3 .45 .5]);
    create_grid =  uicontrol(ubg2,'Style','radiobutton',...
        'FontSize',ZmapGlobal.Data.fontsz.m ,...
        'string','Create grid','Position',[.05 .73 .9 0.2]);
    
    load_grid =  uicontrol(ubg2,'Style','radiobutton',...
        'FontSize',ZmapGlobal.Data.fontsz.m ,...
        'string','Load grid','Position',[.55 .73 .9 0.2]);
    
    
    uicontrol(ubg2,'Style','text',...
        'Position',[.05 .45 .3 0.2],...
        'HorizontalAlignment','left',...
        'String','Spacing (degrees)');
    
    uicontrol(ubg2,'Style','text',...
        'Position',[.35 .45 .09 0.2],...
        'HorizontalAlignment','right',...
        'String','∆x:');
    
    hDeltaX=uicontrol(ubg2,'Style','edit',...
        'Position',[.45 .45 .18 0.2],'String',num2str(dx,'%.2f'),...
        'callback',@callbackfun_dx, 'ToolTipString','grid spacing (x)');
    
    uicontrol(ubg2,'Style','text',...
        'Position',[.65 .45 .09 0.2],...
        'HorizontalAlignment','right',...
        'String','∆y:');
    
    hDeltaY=uicontrol(ubg2,'Style','edit',...
        'Position',[.75 .45 .18 0.2],'String',num2str(dy,'%.2f'),...
        'callback',@callbackfun_dy,'ToolTipString','grid spacing (y)');
    
    % prev_grid =  uicontrol('Style','radiobutton','string','Reuse the previous grid','Position',[.65 .55 .2 .080]);
    % save_grid =  uicontrol('Style','checkbox','string','Save selected grid to file','Position',[.65 .35 .2 .080]);
    
    hGridEntireArea =  uicontrol(ubg2,'Style','checkbox','Position',[.05 .1 .60 0.15],...
        'HorizontalAlignment','left','String','Select area',...
        'Callback',@callback_gridarea,...
        'FontSize',ZmapGlobal.Data.fontsz.m ,...
        'Value',1,...
        'ToolTipString','Either Select Polygon or grid entire area');
    
    ubg2.SelectedObject=create_grid;
    ubg2.SelectionChangedFcn=@callback_gridcontrol;
    %}
    
    % bootstraps
    chKBst_button =  uicontrol('Style','checkbox','Position',[.52 .21 .20 0.08],...
        'HorizontalAlignment','left','String','Mc bootstraps',...
        'FontSize',ZmapGlobal.Data.fontsz.m ,...
        'ToolTipString','Use Bootstrapping','Callback', @callback_bootstrap);
    chkBst_button.Value=0;
    
    uicontrol('Style','text','Position',[.70 .20 .11 0.08],...
        'HorizontalAlignment','right','String','How many?');
    hBootNum=uicontrol('Style','edit',... %active only when bootstrapping
        'Position',[.82 .2 .08 0.08],'String',num2str(nBstSample),...
        'callback',@callbackfun_nbstsmp,'ToolTipString','Number of bootstraps to determine Mc');
    
    
    callback_bootstrap(chkBst_button);
    
    
    uicontrol('Style','text',...
        'Position',[.1 0.35  .21 0.08 ],...
        'HorizontalAlignment','right',...
        'String','Min. No. of events > Mc :');
    
    uicontrol('Style','edit',... %always active
        'Position',[.32 .35 .12 0.08],'String',num2str(Nmin),...
        'callback',@callbackfun_nmin,'ToolTipString','Min # events greater than magnitude of completeness (Mc)');
    %{
        % remarked goup out because fMcFix doesn't seem to be used here
    uicontrol('Style','edit',...
        'Position',[.35 .30 .12 0.08],'String',num2str(fMcFix),...
        'callback',@callbackfun_fmcfix,'ToolTipString','fixed magnitude of completeness (Mc)');
    
    uicontrol('Style','text',...
        'Position',[.05 0.30  .25 0.08 ],...
        'FontSize',ZmapGlobal.Data.fontsz.m ,...
        'HorizontalAlignment','left',...
        'String','Fixed Mc (affects only "Fixed Mc"):');
    %}
    
        
    uicontrol('Style','text',... % always active
        'Position',[.1 0.2  .21 .08 ],...
        'HorizontalAlignment','right',...
        'String','Mc correction for MaxC :');
    
    uicontrol('Style','edit',...
        'Position',[.32 .2 .12 .08],'String',num2str(fMccorr),... %always active
        'callback',@callbackfun_fmcorr,'ToolTipString','Correction term to be added to Mc');
    
    
    
    % Cancel and OK Button's
    uicontrol('Style','Pushbutton',...
        'Position',[.50 .05 .15 .10 ],'callback',@callbackfun_cancel,'String','Cancel');
    
    uicontrol('Style','Pushbutton',...
        'Position',[.70 .05 .15 .10 ],...
        'callback',@callbackfun_go,...
        'String','Go');
    
    
    set(gcf,'visible','on');
    watchoff
    
    function my_calculate()
        % get the grid-size interactively and
        % calculate the b-value in the grid by sorting
        % thge seimicity and selectiong the ni neighbors
        % to each grid point
        
        map = findobj('Name','Seismicity Map');
        
        if bCreateGrid
            % Select and reate grid
            pause(0.5)
            [newgri, xvect, yvect, ll] = ex_selectgrid(map, dx, dy, bGridEntireArea);
            gx = xvect;
            gy = yvect;
        end
        
        
        if bLoadGrid
            %load file
            
            pause(0.5) %the pause is needed there, because sometimes load was ignored
            [file1,path1] = uigetfile(['*.mat'],'b-value gridfile');
            
            if length(path1) > 1
                think
                load([path1 file1])
            end
            
            
        end
        
        % Plot all grid points
        plot(newgri(:,1),newgri(:,2),'+k')
        
        zmap_message_center.set_info(' ','Running... ');think
        %  make grid, calculate start- endtime etc.  ...
        %
        t0b = min(ZG.a.Date)  ;
        n = ZG.a.Count;
        teb = max(ZG.a.Date) ;
        tdiff = round((teb-t0b)/ZG.bin_days);
        loc = zeros(3, length(gx)*length(gy));
        
        % loop over  all points
        %
        bvg = [];
        allcount = 0.;
        wai = waitbar(0,' Please Wait ...  ');
        set(wai,'NumberTitle','off','Name','b-value grid - percent done');
        drawnow
        
        % Overall b-value
        [bv magco stan av me mer me2,  pr] =  bvalca3(ZG.a,ZG.inb1);
        
        itotal = length(newgri(:,1));
        bvg = nan(itotal,14);
        ZG.bo1 = bv; no1 = ZG.a.Count;
        
        % loop over all points
        for i= 1:length(newgri(:,1))
            x = newgri(i,1);y = newgri(i,2);
            allcount = allcount + 1.;
            
            if bUseNiEvents   % take point within r
                b = ZG.a.selectRadius(y,x,ra);      % new data per grid point (b) is sorted in distanc
                rd = ra;
            else
                % take first ni points
                [b,rd] = zG.a.selectClosestEvents(y,x,[],ni);      % new data per grid point (b) is sorted in distance
            end
            
            % Number of earthquakes per node
            [nX,nY] = size(b);
            
            % Estimate the completeness and b-value
            ZG.newt2 = b;
            
            if length(b) >= Nmin  % enough events?
                % Added to obtain goodness-of-fit to powerlaw value
                mcperc_ca3;
                
                [fMc] = calc_Mc(b, ZG.inb1, fBinning, fMccorr);
                l = b.Magnitude >= fMc-(fBinning/2);
                if sum(l) >= Nmin
                    [fMeanMag, fBValue, fStd_B, fAValue] =  calc_bmemag(b.subset(l), fBinning);
                else
                    %fMc = NaN;
                    fBValue = NaN; fStd_B = NaN; fAValue= NaN;
                end
                % Set standard deviation ofa-value to NaN;
                fStd_A= NaN; fStd_Mc = NaN;
                
                % Bootstrap uncertainties
                if chKBst_button.Value == 1
                    % Check Mc from original catalog
                    if sum(l) >= Nmin
                        % following line has only b, but maybe should be b.subset(l)
                        [fMc, fStd_Mc, fBValue, fStd_B, fAValue, fStd_A, vMc, mBvalue] = calc_McBboot(b, fBinning, nBstSample, ZG.inb1);
                    else
                        fMc = NaN;
                        %fStd_Mc = NaN; fBValue = NaN; fStd_B = NaN; fAValue= NaN; fStd_A= NaN;
                    end
                else
                    % Set standard deviation ofa-value to NaN;
                    fStd_A= NaN; fStd_Mc = NaN;
                end
                
                
            else
                fMc = NaN; fStd_Mc = NaN; fBValue = NaN; fStd_B = NaN; fAValue= NaN; fStd_A = NaN;
                %bv = NaN; bv2 = NaN; stan = NaN; stan2 = NaN; prf = NaN; magco = NaN; av = NaN; av2 = NaN;
                fStdDevB = NaN;
                fStdDevMc = NaN;
                prf = NaN;
                b = b.subset([]);
                nX = NaN;
            end
            mab = max(b.Magnitude) ;
            if isempty(mab); mab = NaN; end
            
            % Result matrix
            %bvg(allcount,:)  = [bv magco x y rd bv2 stan2 av stan prf  mab av2 fStdDevB fStdDevMc nX];
            bvg(allcount,:)  = [fMc fStd_Mc x y rd fBValue fStd_B fAValue fStd_A prf mab fStdDevB fStdDevMc nX];
            ZG.bvg=bvg;
            waitbar(allcount/itotal)
        end  % for  newgri
        
        
        catsave3('bvalgrid');
        
        %changed the none error with the positioning of the window
        close(wai)
        watchoff
        
        % plot the results
        % old and re3 (initially ) is the b-value matrix
        %
        
        % normlap2=nan(length(tmpgri(:,1)),1)
        normlap2=nan(length(ll),1)
        % Mc map
        normlap2(ll)= bvg(:,1);
        mMc =reshape(normlap2,length(yvect),length(xvect));
        % Standard deviation Mc
        normlap2(ll)= bvg(:,2);
        mStdMc=reshape(normlap2,length(yvect),length(xvect));
        % Radius resolution
        normlap2(ll)= bvg(:,5);
        r=reshape(normlap2,length(yvect),length(xvect));
        % b-value
        normlap2(ll)= bvg(:,6);
        mBvalue=reshape(normlap2,length(yvect),length(xvect));
        % Standard deviation b-value
        normlap2(ll)= bvg(:,7);
        mStdB=reshape(normlap2,length(yvect),length(xvect));
        %a-value M(0)
        normlap2(ll)= bvg(:,8);
        mAvalue=reshape(normlap2,length(yvect),length(xvect));
        % Standard deviationa-value
        normlap2(ll)= bvg(:,9);
        mStdA=reshape(normlap2,length(yvect),length(xvect));
        % Goodness of fit to power-law map
        normlap2(ll)= bvg(:,10);
        Prmap=reshape(normlap2,length(yvect),length(xvect));
        % Whatever this is
        normlap2(ll)= bvg(:,11);
        ro=reshape(normlap2,length(yvect),length(xvect));
        % Additional runs
        normlap2(ll)= bvg(:,12);
        mStdDevB = reshape(normlap2,length(yvect),length(xvect));
        %
        normlap2(ll)= bvg(:,13);
        mStdDevMc = reshape(normlap2,length(yvect),length(xvect));
        
        normlap2(ll)= bvg(:,14);
        mNumEq = reshape(normlap2,length(yvect),length(xvect));
        
        kll = ll;
        
        re3 = mBvalue;
        old = re3;
        
        % View the b-value map
        view_bva(lab1,re3,gx,gy)
    end
    
    function my_load()
        % Load exist b-grid
        [file1,path1] = uigetfile(['*.mat'],'b-value gridfile');
        if length(path1) > 1
            think
            load([path1 file1])
            % plot the results
            % old and re3 (initially ) is the b-value matrix
            %
            % Mc map
            normlap2(ll)= bvg(:,1);
            mMc =reshape(normlap2,length(yvect),length(xvect));
            % Standard deviation Mc
            normlap2(ll)= bvg(:,2);
            mStdMc=reshape(normlap2,length(yvect),length(xvect));
            % Radius resolution
            normlap2(ll)= bvg(:,5);
            r=reshape(normlap2,length(yvect),length(xvect));
            % b-value
            normlap2(ll)= bvg(:,6);
            mBvalue=reshape(normlap2,length(yvect),length(xvect));
            % Standard deviation b-value
            normlap2(ll)= bvg(:,7);
            mStdB=reshape(normlap2,length(yvect),length(xvect));
            %a-value M(0)
            normlap2(ll)= bvg(:,8);
            mAvalue=reshape(normlap2,length(yvect),length(xvect));
            % Standard deviationa-value
            normlap2(ll)= bvg(:,9);
            mStdA=reshape(normlap2,length(yvect),length(xvect));
            % Goodness of fit to power-law map
            normlap2(ll)= bvg(:,10);
            Prmap=reshape(normlap2,length(yvect),length(xvect));
            % Whatever this is
            normlap2(ll)= bvg(:,11);
            ro=reshape(normlap2,length(yvect),length(xvect));
            % Additional runs
            normlap2(ll)= bvg(:,12);
            mStdDevB = reshape(normlap2,length(yvect),length(xvect));
            %
            normlap2(ll)= bvg(:,13);
            mStdDevMc = reshape(normlap2,length(yvect),length(xvect));
            
            normlap2(ll)= bvg(:,14);
            mNumEq = reshape(normlap2,length(yvect),length(xvect));
            
            
            re3 = mBvalue;
            old = re3;
            
            view_bva(lab1,re3)
            
        else
            return
        end
    end
    
    function callbackfun_001(mysrc,~)
        ZG.inb2=mysrc.Value;
    end
    
    function callbackfun_ni(mysrc,~)
        ni=str2double(mysrc.String);
    end
    
    function callbackfun_ra(mysrc,~)
        ra=str2double(mysrc.String);
    end
    
    function callbackfun_nmin(mysrc,~)
        Nmin=str2double(mysrc.String);
    end
    
    function callbackfun_fmcfix(mysrc,~)
        fMcFix=str2double(mysrc.String);
    end
    
    function callbackfun_nbstsmp(mysrc,~)
        nBstSample=str2double(mysrc.String);
        chKBst_button.Value=1;
    end
    
    function callbackfun_fmcorr(mysrc,~)
        fMccorr=str2double(mysrc.String);
        hMcChoice.Value=1;
    end
    
    function callbackfun_cancel(mysrc,~)
        close;
        done;
    end
    
    %{ 
    %  % replaced by GridParameterChoice object
    
    function callbackfun_dx(mysrc,~)
        dx=str2double(mysrc.String);
    end
    
    function callbackfun_dy(mysrc,~)
        dy=str2double(mysrc.String);
    end
    
    function callback_gridcontrol(mysrc,~)
        if mysrc.SelectedObject == create_grid
            set([hDeltaX,hDeltaY],'Enable','on');
        else
            set([hDeltaX,hDeltaY],'Enable','off');
        end
    end
    
    function callback_gridarea(mysrc,~)
        bGridEntireArea= ~mysrc.Value;
    end
    %}
    
    function callback_selectioncontrol(mysrc,~)
        if mysrc.SelectedObject == hUseNevents
            set([hRa],'Enable','off');
            set([hNi],'Enable','on');
        else
            set([hNi],'Enable','off');
            set([hRa],'Enable','on');
        end
    end
    
    function callbackfun_go(mysrc,~)
        ZG.inb1=hMcChoice.Value;
        
        dx=gridOpts.dx; 
        dy=gridOpts.dy; 
        bGridEntireArea=gridOpts.GridEntireArea;
        bCreateGrid=gridOpts.CreateGrid;
        bLoadGrid=gridOpts.LoadGrid;
        
        bUseNiEvents=ubg1.SelectedObject == hUseNevents;
        
        %ZG.ra=ra;
        %ZG.ni=ni;
        % oldfig_button=oldfig_button.Value;
        
        delete(gridOpts);
        close;
        
        my_calculate();
    end
    function callback_bootstrap(mysrc,~)
        if mysrc.Value
            hBootNum.Enable='on';
        else
            hBootNum.Enable='off';
        end
    end
    
end
